<!doctype HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>code.pyret.org</title>
  <link rel="stylesheet" href="reset.css"></link>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
  <link rel="stylesheet" href="/lib/CodeMirror/lib/codemirror.css"></link>
  <link rel="stylesheet" href="editor.css"></link>
</head>
<body>
<div id="header">
  <div id="docs"><a href="doc.txt" target="_blank">Documentation</a></div>
  <div id="programs"><a>My Programs</a></div>
  <div id="logout"><a>Logout</a></div>
</div>
<div id="toolbar">
  <div id="program-name-container">
    <label for="program-name">Program Name:</label>
    <input id="program-name" type="text"></input>
  </div>
  <button id="saveButton" class="blueButton">Save</button>
  <button id="shareButton" class="blueButton">Share</button>
  <button id="breakButton" class="blueButton rhs">Stop</button>
  <button id="runButton" class="blueButton rhs">Run</button>
</div>
<div id="loader"><p>Raising the masts...</p></div>
<div id="main">
<div id="REPL" class="replContainer"></div>
</div>
<div id="footer"></div>
</body>

<script src="/node_modules/requirejs/require.js"></script>
<script>
requirejs.config({
  paths: {
//      "js": "js/",
//      "compiler": "arr/compiler/",
//      "arr": "arr/",
//      "trove": "trove",
    "q": "/node_modules/q/q",
    "fs": "/src/web/fsstub"
  },
  waitSeconds: 0
});
</script>
<script src="/node_modules/pyret-lang/build/phase0/pyret.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="/lib/CodeMirror/lib/codemirror.js"></script>
<script src="/lib/CodeMirror/addon/edit/matchbrackets.js"></script>
<script src="/lib/CodeMirror/mode/pyret/pyret.js"></script>
<script src="draw.js"></script>
<!--  <script type="text/javascript"
        src="https://caja.appspot.com/caja.js"></script> -->
<script>
LOG = true;
function ct_log(/* varargs */) {
  if (window.console && LOG) {
    console.log.apply(console, arguments);
  }
}
function ct_error(/* varargs */) {
  if (window.console && LOG) {
    console.error.apply(console, arguments);
  }
}
$(function() {
  var texts = [
      "Raising the masts...",
      "Securing the oarlocks...",
      "Hoisting the anchor...",
      "Swabbing the decks...",
      "Debarnacling the keel...",
      "Checking the cargo manifest...",
      "Assembling the crew...",
      "Inspecting the turnbuckles...",
      "Furling the rollers...",
      "Lashing the jib-boom..."
    ];
  $("#loader p").text(texts[Math.floor(Math.random() * texts.length)]);
  setInterval(function() {
    $("#loader p").text(texts[Math.floor(Math.random() * texts.length)]);
  }, 1300);
  var BASE = "http://cs.brown.edu/~joe/private/pyret-dev/";
  define("repl-main", ["js/repl-lib", "/src/web/repl-ui.js", "js/runtime-anf", "js/dialects-lib"], function(replLib, replUI, rtLib, dialectLib) {
    $("#loader").hide();
    var replContainer = $("<div>").addClass("repl");
    $("#REPL").append(replContainer);
    var runtime = rtLib.makeRuntime({stdout: function(str) { console.log(str); } });
    var dialects = dialectLib(runtime, runtime.namespace);
    var dialectStr = window.location.hash.slice(1);
    var dialect = dialects.dialects[dialectStr] || dialects.dialects["Bootstrap"]; // TODO: CHANGE THIS AS NEEDED
    var replNS = dialect.makeNamespace(runtime);
    var replEnv = dialect.compileEnv;
    var repl = replLib.create(runtime, replNS, replEnv, {name: "definitions", dialect: dialectStr || "Bootstrap"});

    // NOTE(joe): This forces the loading of all the built-in compiler libs
    repl.restartInteractions("");

    var replWidget = replUI.makeRepl(replContainer, repl, runtime, {
        breakButton: $("#breakButton")
      });
    window.RUN_CODE = function(src, uiOpts, replOpts) {
      replWidget.runCode(src, uiOpts, replOpts);
    };
    var codeContainer = $("<div>").addClass("replMain");
    $("#main").prepend(codeContainer);
    var editor = replUI.makeEditor(codeContainer, {
        runButton: $("#runButton"),
        simpleEditor: false,
        initial: "print('Ahoy, world!')",
        run: RUN_CODE,
        initialGas: 500
      });
    $(document).on("keydown", function(e) {
      if(e.ctrlKey) {
        if(e.keyCode === 68) { // "Ctrl-d"
          editor.focus();
          e.stopImmediatePropagation();
        } else if(e.keyCode === 73) { // "Ctrl-i"
          replWidget.focus();
          e.stopImmediatePropagation();
        }
      }
    });
    var lskey = "patch_saved_program";
    function save() {
      window.localStorage.setItem(lskey, editor.cm.getValue());
    }
    $("#saveButton").click(save);
    setInterval(save, 3000);
    if(window.localStorage.hasOwnProperty(lskey)) {
      editor.cm.setValue(window.localStorage.getItem(lskey));
    }
    editor.focus();
  });
  require(["repl-main"]);
});
</script>
<script type="text/javascript">
  /**
   * Called when the client library is loaded to start the auth flow.
   */
  function handleClientLoad() {
    var token = window.location.hash.slice(1);
    gapi.auth.setToken({ access_token: token });
  }
</script>
<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
</html>

