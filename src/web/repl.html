<!doctype HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>code.pyret.org</title>
  <link rel="stylesheet" href="/src/web/reset.css"></link>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
  <link rel="stylesheet" href="/lib/CodeMirror/lib/codemirror.css"></link>
  <link rel="stylesheet" href="/src/web/shared.css"></link>
  <link rel="stylesheet" href="/src/web/editor.css"></link>
</head>
<body>
<div id="header">
  <div id="docs"><a href="/src/web/doc.txt" target="_blank">Documentation</a></div>
  <div id="programs" class="loginOnly"><a href="/my-programs">My Programs</a></div>
  <div id="logout" class="loginOnly"><a href="/logout">Logout</a></div>
</div>
<div id="toolbar">
  <div id="program-name-container" class="loginOnly">
    <label for="program-name">Program Name:</label>
    <input id="program-name" type="text"></input>
  </div>
  <button id="saveButton" class="loginOnly blueButton">Save</button>
  <button id="shareButton" class="loginOnly blueButton">Share</button>
  <span id="notification" class="notificationArea"></span>
  <button id="breakButton" class="blueButton rhs">Stop</button>
  <button id="runButton" class="blueButton rhs">Run</button>
</div>
<div id="loader"><p>Raising the masts...</p></div>
<div id="main">
<div id="REPL" class="replContainer"></div>
</div>
<div id="footer"></div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="/node_modules/url.js/url.js"></script>
<script src="/node_modules/q/q.js"></script>
<script src="/src/web/programs.js"></script>
<script type="text/javascript">
  var storageAPI;
  function handleClientLoad() {
    function refresh(then) {
      $.ajax("/getAccessToken").then(then);
    }
    var getAccess = $.ajax("/getAccessToken");
    getAccess.then(function(data) {
      createProgramCollectionAPI("code.pyret.org", data.access_token, refresh, function(api) {
        storageAPI = api;
      });
      $(".loginOnly").show();
    });
    getAccess.error(function(err) {
      console.log("Not logged in; proceeding without login info");
    });
  }
</script>
<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>

<script src="/node_modules/requirejs/require.js"></script>
<script>
requirejs.config({
  paths: {
//      "js": "js/",
//      "compiler": "arr/compiler/",
//      "arr": "arr/",
//      "trove": "trove",
    "q": "/node_modules/q/q",
    "fs": "/src/web/fsstub"
  },
  waitSeconds: 0
});
</script>
<script src="/node_modules/pyret-lang/build/phase0/pyret.js"></script>
<script src="/lib/CodeMirror/lib/codemirror.js"></script>
<script src="/lib/CodeMirror/addon/edit/matchbrackets.js"></script>
<script src="/lib/CodeMirror/mode/pyret/pyret.js"></script>
<script src="/src/web/draw.js"></script>
<script src="/src/web/loader.js"></script>
<!--  <script type="text/javascript"
        src="https://caja.appspot.com/caja.js"></script> -->
<script>
LOG = true;
function ct_log(/* varargs */) {
  if (window.console && LOG) {
    console.log.apply(console, arguments);
  }
}
function ct_error(/* varargs */) {
  if (window.console && LOG) {
    console.error.apply(console, arguments);
  }
}
$(function() {
  var BASE = "http://cs.brown.edu/~joe/private/pyret-dev/";
  define("repl-main", ["js/repl-lib", "/src/web/repl-ui.js", "js/runtime-anf", "js/dialects-lib"], function(replLib, replUI, rtLib, dialectLib) {
    $("#loader").hide();
    var replContainer = $("<div>").addClass("repl");
    $("#REPL").append(replContainer);
    var runtime = rtLib.makeRuntime({stdout: function(str) { console.log(str); } });
    var dialects = dialectLib(runtime, runtime.namespace);
    var dialectStr = window.location.hash.slice(1);
    var dialect = dialects.dialects[dialectStr] || dialects.dialects["Bootstrap"]; // TODO: CHANGE THIS AS NEEDED
    var replNS = dialect.makeNamespace(runtime);
    var replEnv = dialect.compileEnv;
    var repl = replLib.create(runtime, replNS, replEnv, {name: "definitions", dialect: dialectStr || "Bootstrap"});

    // NOTE(joe): This forces the loading of all the built-in compiler libs
    repl.restartInteractions("");

    var replWidget = replUI.makeRepl(replContainer, repl, runtime, {
        breakButton: $("#breakButton")
      });
    window.RUN_CODE = function(src, uiOpts, replOpts) {
      replWidget.runCode(src, uiOpts, replOpts);
    };
    var codeContainer = $("<div>").addClass("replMain");
    $("#main").prepend(codeContainer);
    var editor = replUI.makeEditor(codeContainer, {
        runButton: $("#runButton"),
        simpleEditor: false,
        initial: "print('Ahoy, world!')",
        run: RUN_CODE,
        initialGas: 500
      });
    $(document).on("keydown", function(e) {
      if(e.ctrlKey) {
        if(e.keyCode === 68) { // "Ctrl-d"
          editor.focus();
          e.stopImmediatePropagation();
        } else if(e.keyCode === 73) { // "Ctrl-i"
          replWidget.focus();
          e.stopImmediatePropagation();
        }
      }
    });
    
    var lskey = "patch_saved_program";
    var currentFile;
    
    storageAPI.

    function save() {
      if(!currentFile) {
        var programName = $("#program-name").val() || "Untitled";
        storageAPI.createFile(programName, function(file) { currentFile = file; save(); });
      }
      else {
        currentFile.save(editor.cm.getValue(), false, function(afterSaveVal) {
          console.log("Program saved", afterSaveVal);
        });
      }
    }
    $("#saveButton").click(save);
    if(window.localStorage.hasOwnProperty(lskey)) {
      editor.cm.setValue(window.localStorage.getItem(lskey));
    }
    editor.focus();
  });
  require(["repl-main"]);
});
</script>
</html>

