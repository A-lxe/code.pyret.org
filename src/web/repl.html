<!doctype HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Patch â”„ Bootstrap</title>
  <link rel="stylesheet" href="reset.css"></link>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
  <link rel="stylesheet" href="/lib/CodeMirror/lib/codemirror.css"></link>
  <link rel="stylesheet" href="editor.css"></link>
</head>
<body>
<div id="header">
  <div id="docs"><a href="doc.txt" target="_blank">Documentation</a></div>
  <div id="programs"><a>My Programs</a></div>
  <div id="logout"><a>Logout</a></div>
</div>
<div id="toolbar">
  <div id="program-name-container">
    <label for="program-name">Project Name:</label>
    <input id="program-name" type="text"></input>
  </div>
  <button id="saveButton" class="blueButton">Save</button>
  <button id="shareButton" class="blueButton">Share</button>
  <button id="authorizeButton" class="blueButton">Authorize</button>
  <input type="file" id="filePicker" style="display: none" />
  <button id="breakButton" class="blueButton rhs">Stop</button>
  <button id="runButton" class="blueButton rhs">Run</button>
</div>
<div id="loader"><p>Raising the masts...</p></div>
<div id="main">
<div id="REPL" class="replContainer"></div>
</div>
<div id="footer"></div>
</body>

<script src="/node_modules/requirejs/require.js"></script>
<script>
requirejs.config({
  paths: {
//      "js": "js/",
//      "compiler": "arr/compiler/",
//      "arr": "arr/",
//      "trove": "trove",
    "q": "/node_modules/q/q",
    "fs": "/src/web/fsstub"
  },
  waitSeconds: 0
});
</script>
<script src="/node_modules/pyret-lang/build/phase0/pyret.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="/lib/CodeMirror/lib/codemirror.js"></script>
<script src="/lib/CodeMirror/addon/edit/matchbrackets.js"></script>
<script src="/lib/CodeMirror/mode/pyret/pyret.js"></script>
<script src="draw.js"></script>
<!--  <script type="text/javascript"
        src="https://caja.appspot.com/caja.js"></script> -->
<script>
LOG = true;
function ct_log(/* varargs */) {
  if (window.console && LOG) {
    console.log.apply(console, arguments);
  }
}
function ct_error(/* varargs */) {
  if (window.console && LOG) {
    console.error.apply(console, arguments);
  }
}
$(function() {
  var texts = [
      "Raising the masts...",
      "Securing the oarlocks...",
      "Hoisting the anchor...",
      "Swabbing the decks...",
      "Debarnacling the keel...",
      "Checking the cargo manifest...",
      "Assembling the crew...",
      "Inspecting the turnbuckles...",
      "Furling the rollers...",
      "Lashing the jib-boom..."
    ];
  $("#loader p").text(texts[Math.floor(Math.random() * texts.length)]);
  setInterval(function() {
    $("#loader p").text(texts[Math.floor(Math.random() * texts.length)]);
  }, 1300);
  var BASE = "http://cs.brown.edu/~joe/private/pyret-dev/";
  define("repl-main", ["js/repl-lib", "/src/web/repl-ui.js", "js/runtime-anf", "js/dialects-lib"], function(replLib, replUI, rtLib, dialectLib) {
    $("#loader").hide();
    var replContainer = $("<div>").addClass("repl");
    $("#REPL").append(replContainer);
    var runtime = rtLib.makeRuntime({stdout: function(str) { console.log(str); } });
    var dialects = dialectLib(runtime, runtime.namespace);
    var dialect = window.location.hash.slice(1) || "Bootstrap"; // TODO: CHANGE THIS AS NEEDED
    var replNS = dialects.dialects[dialect].makeNamespace(runtime);
    var replEnv = dialects.dialects[dialect].compileEnv;
    var repl = replLib.create(runtime, replNS, replEnv, {name: "definitions", dialect: dialect});

    // NOTE(joe): This forces the loading of all the built-in compiler libs
    repl.restartInteractions("");

    var replWidget = replUI.makeRepl(replContainer, repl, runtime, {
        breakButton: $("#breakButton")
      });
    window.RUN_CODE = function(src, uiOpts, replOpts) {
      replWidget.runCode(src, uiOpts, replOpts);
    };
    var codeContainer = $("<div>").addClass("replMain");
    $("#main").prepend(codeContainer);
    var editor = replUI.makeEditor(codeContainer, {
        runButton: $("#runButton"),
        simpleEditor: false,
        initial: "print('Ahoy, world!')",
        run: RUN_CODE,
        initialGas: 500
      });
    $(document).on("keydown", function(e) {
      if(e.ctrlKey) {
        if(e.keyCode === 68) { // "Ctrl-d"
          editor.focus();
          e.stopImmediatePropagation();
        } else if(e.keyCode === 73) { // "Ctrl-i"
          replWidget.focus();
          e.stopImmediatePropagation();
        }
      }
    });
    var lskey = "patch_saved_program";
    function save() {
      window.localStorage.setItem(lskey, editor.cm.getValue());
    }
    $("#saveButton").click(save);
    setInterval(save, 3000);
    if(window.localStorage.hasOwnProperty(lskey)) {
      editor.cm.setValue(window.localStorage.getItem(lskey));
    }
    editor.focus();
  });
  require(["repl-main"]);
});
</script>
    <script type="text/javascript">
      var CLIENT_ID = '2769265824-76uj40ta2acjagbclphajaiviv69mff1.apps.googleusercontent.com';
      var SCOPES = 'https://www.googleapis.com/auth/drive';

      /**
       * Called when the client library is loaded to start the auth flow.
       */
      function handleClientLoad() {
        window.setTimeout(checkAuth, 1);
      }

      /**
       * Check if the current user has authorized the application.
       */
      function checkAuth() {
        gapi.auth.authorize(
            {'client_id': CLIENT_ID, 'scope': SCOPES, 'immediate': true},
            handleAuthResult);
      }

      /**
       * Called when authorization server replies.
       *
       * @param {Object} authResult Authorization result.
       */
      function handleAuthResult(authResult) {
        var authButton = document.getElementById('authorizeButton');
        var filePicker = document.getElementById('filePicker');
        authButton.style.display = 'none';
        filePicker.style.display = 'none';
        if (authResult && !authResult.error) {
          // Access token has been successfully retrieved, requests can be sent to the API.
          filePicker.style.display = 'block';
          filePicker.onchange = uploadFile;
        } else {
          // No access token could be retrieved, show the button to start the authorization flow.
          authButton.style.display = 'block';
          authButton.onclick = function() {
              gapi.auth.authorize(
                  {'client_id': CLIENT_ID, 'scope': SCOPES, 'immediate': false},
                  handleAuthResult);
          };
        }
      }

      /**
       * Start the file upload.
       *
       * @param {Object} evt Arguments from the file selector.
       */
      function uploadFile(evt) {
        gapi.client.load('drive', 'v2', function() {
          var file = evt.target.files[0];
          insertFile(file);
        });
      }

      /**
       * Insert new file.
       *
       * @param {File} fileData File object to read data from.
       * @param {Function} callback Function to call when the request is complete.
       */
      function insertFile(fileData, callback) {
        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        var reader = new FileReader();
        reader.readAsBinaryString(fileData);
        reader.onload = function(e) {
          var contentType = fileData.type || 'application/octet-stream';
          var metadata = {
            'title': fileData.name,
            'mimeType': contentType
          };

          var base64Data = btoa(reader.result);
          var multipartRequestBody =
              delimiter +
              'Content-Type: application/json\r\n\r\n' +
              JSON.stringify(metadata) +
              delimiter +
              'Content-Type: ' + contentType + '\r\n' +
              'Content-Transfer-Encoding: base64\r\n' +
              '\r\n' +
              base64Data +
              close_delim;

          var request = gapi.client.request({
              'path': '/upload/drive/v2/files',
              'method': 'POST',
              'params': {'uploadType': 'multipart'},
              'headers': {
                'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
              },
              'body': multipartRequestBody});
          if (!callback) {
            callback = function(file) {
              console.log(file)
            };
          }
          request.execute(callback);
        }
      }
    </script>
    <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
  </head>
  <body>
    <!--Add a file picker for the user to start the upload process -->
  </body>
</html>

