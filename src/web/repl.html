<!doctype HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>code.pyret.org</title>
  <link rel="stylesheet" href="/src/web/reset.css"></link>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
  <link rel="stylesheet" href="/lib/CodeMirror/lib/codemirror.css"></link>
  <link rel="stylesheet" href="/src/web/shared.css"></link>
  <link rel="stylesheet" href="/src/web/editor.css"></link>
</head>
<body>
<div id="header">
  <div id="docs"><a href="/src/web/doc.txt" target="_blank">Documentation</a></div>
  <div id="programs" class="loginOnly"><a href="/my-programs">My Programs</a></div>
  <div id="logout" class="loginOnly"><a href="/logout">Logout</a></div>
</div>
<div id="toolbar">
  <button id="connectButton" class="logoutOnly">Connect to Google Drive</button>
  <div id="program-name-container" class="loginOnly">
    <label for="program-name">Program Name:</label>
    <input id="program-name" type="text"></input>
  </div>
  <button id="saveButton" class="loginOnly blueButton">Save</button>
  <button id="shareButton" class="loginOnly blueButton">Share</button>
  <span id="notification" class="notificationArea"></span>
  <button id="breakButton" class="blueButton rhs">Stop</button>
  <button id="runButton" class="blueButton rhs">Run</button>
</div>
<div id="loader"><p>Raising the masts...</p></div>
<div id="main">
<div id="REPL" class="replContainer"></div>
<div id="help-keys">
  <p>Press ESC to close this help window</p>
  <ul>
    <li><b>Ctrl-?</b> - Show this help</li>
    <li><b>Ctrl-d</b> - Goto definitions window</li>
    <li><b>Ctrl-i</b> - Goto interactions window</li>
    <li><b>Ctrl-Enter</b> - Run the definitions window</li>
  </ul>
</div>
</div>
<div id="footer"></div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="/src/web/loader.js"></script>
<script src="/node_modules/url.js/url.js"></script>
<script src="/node_modules/q/q.js"></script>
<script src="/src/web/programs.js"></script>
<script src="/src/web/authenticate-storage.js"></script>
<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>

<script src="/node_modules/requirejs/require.js"></script>
<script>
requirejs.config({
  paths: {
//      "js": "js/",
//      "compiler": "arr/compiler/",
//      "arr": "arr/",
//      "trove": "trove",
    "q": "/node_modules/q/q",
    "fs": "/src/web/fsstub",
    "trove": "/src/web/teachpacks/"
  },
  waitSeconds: 0
});
</script>
<script src="/src/web/pyret.js"></script>
<script src="/lib/CodeMirror/lib/codemirror.js"></script>
<script src="/lib/CodeMirror/addon/edit/matchbrackets.js"></script>
<script src="/src/web/draw.js"></script>
<script src="/lib/CodeMirror/mode/pyret/pyret.js"></script>
<!--  <script type="text/javascript"
        src="https://caja.appspot.com/caja.js"></script> -->
<script>
LOG = true;
function ct_log(/* varargs */) {
  if (window.console && LOG) {
    console.log.apply(console, arguments);
  }
}
function ct_error(/* varargs */) {
  if (window.console && LOG) {
    console.error.apply(console, arguments);
  }
}
$(function() {
  var BASE = "http://cs.brown.edu/~joe/private/pyret-dev/";
  define("repl-main", ["js/repl-lib", "/src/web/repl-ui.js", "js/runtime-anf", "js/dialects-lib"], function(replLib, replUI, rtLib, dialectLib) {
    var replContainer = $("<div>").addClass("repl");
    $("#REPL").append(replContainer);
    var runtime = rtLib.makeRuntime({stdout: function(str) { console.log(str); } });
    var dialects = dialectLib(runtime, runtime.namespace);
    var dialectStr = window.location.hash.slice(1);
    var dialect = dialects.dialects[dialectStr] || dialects.dialects["Bootstrap"]; // TODO: CHANGE THIS AS NEEDED
    var replNS = dialect.makeNamespace(runtime);
    var replEnv = dialect.compileEnv;
    var repl = replLib.create(runtime, replNS, replEnv, {name: "definitions", dialect: dialectStr || "Bootstrap"});

    // NOTE(joe): This forces the loading of all the built-in compiler libs
    var interactionsReady = repl.restartInteractions("");

    var replWidget = replUI.makeRepl(replContainer, repl, runtime, {
        breakButton: $("#breakButton")
      });
    window.RUN_CODE = function(src, uiOpts, replOpts) {
      replWidget.runCode(src, uiOpts, replOpts);
    };
    var codeContainer = $("<div>").addClass("replMain");
    $("#main").prepend(codeContainer);
    var editor = replUI.makeEditor(codeContainer, {
        runButton: $("#runButton"),
        simpleEditor: false,
        initial: "print('Ahoy, world!')",
        run: RUN_CODE,
        initialGas: 500
      });
    $(document).on("keyup", function(e) {
      if(e.keyCode === 27) { // "ESC"
        $("#help-keys").fadeOut(500);
        e.stopImmediatePropagation();
      }
    });
    $(document).on("keydown", function(e) {
      if(e.ctrlKey) {
        if(e.keyCode === 68) { // "Ctrl-d"
          editor.focus();
          e.stopImmediatePropagation();
        } else if(e.keyCode === 73) { // "Ctrl-i"
          replWidget.focus();
          e.stopImmediatePropagation();
        } else if(e.keyCode === 191 && e.shiftKey) { // "Ctrl-?"
          $("#help-keys").fadeIn(100);
          e.stopImmediatePropagation();
        }
      }
    });
    
    var lskey = "patch_saved_program";
    var currentFile;

    var params = url.parse(document.location.href);
    var initialProgramId = null;
    if(params["get"] && params["get"]["program"]) {
      initialProgramId = params["get"]["program"];
    }

    storageAPI.then(function() {
      $(".loginOnly").show();
      $(".logoutOnly").hide();
    });
    storageAPI.fail(function() {
      $(".loginOnly").hide();
      $(".logoutOnly").show();
    });
    $("#connectButton").click(function() {
      $("#connectButton").text("Connecting...");
      $("#connectButton").attr("disabled", "disabled");
      storageAPI = createProgramCollectionAPI("code.pyret.org", false);
      storageAPI.then(function(api) {
        $(".loginOnly").show();
        $(".logoutOnly").hide();
        programToSave = Q.fcall(function() { return null; });
      });
      storageAPI.fail(function(err) {
        $("#connectButton").text("Connect to Google Drive");
      });
    });

    var initialProgram = storageAPI.then(function(api) {
      if(initialProgramId) {
        var programLoad = api.getFileById(initialProgramId);
        programLoad.fail(function(err) {
          console.error(err);
          flashError("The program failed to load.");
        });
        return programLoad;
      } else {
        return null;
      }
    })

    var programLoaded = initialProgram.then(function(p) {
      if(p !== null) {
        $("#program-name").val(p.getName());
        return p.getContents().then(function(c) {
          editor.cm.setValue(c);
        });
      }
    });

    var programToSave = initialProgram;

    function nameOrUntitled() {
      return $("#program-name").val() || "Untitled";
    }
    function save() {
      flashMessage("Saving...");
      var savedProgram = programToSave.then(function(p) {
        if(p !== null) {
          if(p.getName() !== $("#program-name").val()) {
            programToSave = p.rename(nameOrUntitled()).then(function(newP) {
              return newP;
            });
          }
          return programToSave
          .then(function(p) {
            return p.save(editor.cm.getValue(), false);
          })
          .then(function(p) {
            $("#program-name").val(p.getName());
            flashMessage("Program saved as " + p.getName());
            return p;
          })
        }
        else {
          var programName = $("#program-name").val() || "Untitled";
          $("#program-name").val(programName);
          programToSave = storageAPI
            .then(function(api) { return api.createFile(programName); });
          return save();
        }
      });
      savedProgram.fail(function(err) {
        flashError("Program failed to save.");
      });
    }
    $("#saveButton").click(save);

    Q.all([programLoaded, interactionsReady]).fin(function() { $("#loader").hide(); });
    editor.focus();
  });
  require(["repl-main"]);
});
function clearFlash() {
  $(".notificationArea").empty();
}
function flashError(message) {
  clearFlash();
  var err = $("<span>").addClass("error").text(message);
  $(".notificationArea").append(err);
  err.fadeOut(7000);
}
function flashMessage(message) {
  clearFlash();
  var err = $("<span>").addClass("active").text(message);
  $(".notificationArea").append(err);
  err.fadeOut(7000);
}
    
</script>
</html>

