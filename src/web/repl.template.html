<!doctype HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>code.pyret.org</title>
  <link rel="stylesheet" href="/css/reset.css"></link>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
  <link rel="stylesheet" href="/css/codemirror.css"></link>
  <link rel="stylesheet" href="/css/shared.css"></link>
  <link rel="stylesheet" href="/css/editor.css"></link>
</head>
<body>
<div id="header">
  <div id="docs"><a target="_blank">Documentation</a></div>
  <div id="programs" class="loginOnly"><a target="_blank" href="/my-programs.html">My Programs</a></div>
</div>
<div id="toolbar">
  <button id="connectButton" class="logoutOnly blueButton">Connect to Google Drive</button>
  <div id="program-name-container" class="loginOnly">
    <label for="program-name">Program Name:</label>
    <input id="program-name" type="text"></input>
  </div>
  <button id="saveButton" class="loginOnly blueButton">Save</button>
  <button id="shareButton" class="loginOnly blueButton">Share</button>
  <span id="notification" class="notificationArea"></span>
  <button id="breakButton" class="blueButton rhs">Stop</button>
  <button id="runButton" class="blueButton rhs">Run</button>
</div>
<div id="loader"><p>Raising the masts...</p></div>
<div id="main">
<div id="REPL" class="replContainer"></div>
<div id="help-keys">
  <p>Press ESC to close this help window</p>
  <ul>
    <li><b>Ctrl-?</b> - Show this help</li>
    <li><b>Ctrl-d</b> - Goto definitions window</li>
    <li><b>Ctrl-i</b> - Goto interactions window</li>
    <li><b>Ctrl-Enter</b> - Run the definitions window</li>
  </ul>
</div>
</div>
<div id="footer"></div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script src="/js/loader.js"></script>
<script src="/js/url.js"></script>
<script src="/js/q.js"></script>
<script src="/js/programs.js"></script>
<script src="/js/authenticate-storage.js"></script>
<script>
var clientId = "{{ google_client_id }}";
var apiKey = "{{ google_api_key }}";
function handleGoogLoad() {
  handleClientLoad(clientId, apiKey);
}
</script>
<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleGoogLoad"></script>
<script src="/js/codemirror.js"></script>
<script src="/js/matchbrackets.js"></script>
<script src="/js/draw.js"></script>
<script src="/js/pyret-mode.js"></script>
<script src="/js/require.js"></script>
<script>
requirejs.config({
  paths: {
//      "js": "js/",
//      "compiler": "arr/compiler/",
//      "arr": "arr/",
//      "trove": "trove",
    "q": "/js/q",
    "fs": "/js/fsstub"
  },
  waitSeconds: 0
});
</script>
<script src="/js/pyret.js"></script>
<!--  <script type="text/javascript"
        src="https://caja.appspot.com/caja.js"></script> -->
<script>
LOG = true;
function ct_log(/* varargs */) {
  if (window.console && LOG) {
    console.log.apply(console, arguments);
  }
}
function ct_error(/* varargs */) {
  if (window.console && LOG) {
    console.error.apply(console, arguments);
  }
}
$(function() {
  var BASE = "http://cs.brown.edu/~joe/private/pyret-dev/";
  define("repl-main", ["js/repl-lib", "/js/repl-ui.js", "js/runtime-anf", "js/dialects-lib"], function(replLib, replUI, rtLib, dialectLib) {
    var replContainer = $("<div>").addClass("repl");
    $("#REPL").append(replContainer);
    var runtime = rtLib.makeRuntime({stdout: function(str) { console.log(str); } });

    var initialParams = url.parse(document.location.href);
    var params = url.parse("/?" + initialParams["hash"]);

    var dialects = dialectLib(runtime, runtime.namespace);
    var dialectStr = params["get"] ? params["get"]["lang"] : "Pyret";
    if (!dialects.dialects[dialectStr]) { dialectStr = "Pyret"; }
    var dialect = dialects.dialects[dialectStr]; // TODO: CHANGE THIS AS NEEDED
    var replNS = dialect.makeNamespace(runtime);
    var replEnv = dialect.compileEnv;
    var repl = replLib.create(runtime, replNS, replEnv, {name: "definitions", dialect: dialectStr});

    // NOTE(joe): This forces the loading of all the built-in compiler libs
    var interactionsReady = repl.restartInteractions("");

    var replWidget = replUI.makeRepl(replContainer, repl, runtime, {
        breakButton: $("#breakButton")
      });
    window.RUN_CODE = function(src, uiOpts, replOpts) {
      replWidget.runCode(src, uiOpts, replOpts);
    };
    var codeContainer = $("<div>").addClass("replMain");
    $("#main").prepend(codeContainer);
    var editor = replUI.makeEditor(codeContainer, {
        runButton: $("#runButton"),
        simpleEditor: false,
        initial: "print('Ahoy, world!')",
        run: RUN_CODE,
        initialGas: 500
      });
    $(document).on("keyup", function(e) {
      if(e.keyCode === 27) { // "ESC"
        $("#help-keys").fadeOut(500);
        e.stopImmediatePropagation();
      }
    });
    $(document).on("keydown", function(e) {
      if(e.ctrlKey) {
        if(e.keyCode === 68) { // "Ctrl-d"
          editor.focus();
          e.stopImmediatePropagation();
        } else if(e.keyCode === 73) { // "Ctrl-i"
          replWidget.focus();
          e.stopImmediatePropagation();
        } else if(e.keyCode === 191 && e.shiftKey) { // "Ctrl-?"
          $("#help-keys").fadeIn(100);
          e.stopImmediatePropagation();
        }
      }
    });
    

    storageAPI.then(function(api) {
      api.collection.then(function() {
        $(".loginOnly").show();
        $(".logoutOnly").hide();
      });
      api.collection.fail(function() {
        $(".loginOnly").hide();
        $(".logoutOnly").show();
      });
    });

    storageAPI = storageAPI.then(function(api) { return api.api; });
    $("#connectButton").click(function() {
      $("#connectButton").text("Connecting...");
      $("#connectButton").attr("disabled", "disabled");
      storageAPI = createProgramCollectionAPI(clientId, "code.pyret.org", false);
      storageAPI.then(function(api) {
        api.collection.then(function() {    
          $(".loginOnly").show();
          $(".logoutOnly").hide();
          programToSave = Q.fcall(function() { return null; });
        });
        api.collection.fail(function(err) {
          $("#connectButton").text("Connect to Google Drive");
          $("#connectButton").attr("disabled", false);
        });
      });
      storageAPI = storageAPI.then(function(api) { return api.api; });
    });

    var copyOnSave = false;

    var initialProgram = storageAPI.then(function(api) {
      var programLoad = null;
      if(params["get"] && params["get"]["program"]) {
        programLoad = api.getFileById(params["get"]["program"]);
      }
      if(params["get"] && params["get"]["share"]) {
        programLoad = api.getSharedFileById(params["get"]["share"]);
        $("#saveButton").text("Save a Copy");
        copyOnSave = true;
      }
      if(programLoad) {
        programLoad.fail(function(err) {
          console.error(err);
          flashError("The program failed to load.");
        });
        return programLoad;
      } else {
        return null;
      }
    });

    function setTitle(progName) {
      document.title = progName + " - code.pyret.org";
    }

    var programLoaded = initialProgram.then(function(p) {
      console.log("Initial program: ", p);
      if(p !== null) {
        $("#program-name").val(p.getName());
        setTitle(p.getName());
        return p.getContents().then(function(c) {
          editor.cm.setValue(c);
        });
      }
    });

    var programToSave = initialProgram;

    function nameOrUntitled() {
      return $("#program-name").val() || "Untitled";
    }
    function save() {
      flashMessage("Saving...");
      var savedProgram = programToSave.then(function(p) {
        if(p !== null && !copyOnSave) {
          if(p.getName() !== $("#program-name").val()) {
            programToSave = p.rename(nameOrUntitled()).then(function(newP) {
              return newP;
            });
          }
          return programToSave
          .then(function(p) {
            return p.save(editor.cm.getValue(), false);
          })
          .then(function(p) {
            $("#program-name").val(p.getName());
            $("#saveButton").text("Save");
            history.pushState(null, null, "#program=" + p.getUniqueId());
            window.location.hash = "#program=" + p.getUniqueId();
            flashMessage("Program saved as " + p.getName());
            setTitle(p.getName());
            return p;
          })
        }
        else {
          var programName = $("#program-name").val() || "Untitled";
          $("#program-name").val(programName);
          programToSave = storageAPI
            .then(function(api) { return api.createFile(programName); });
          copyOnSave = false;
          return save();
        }
      });
      savedProgram.fail(function(err) {
        flashError("Program failed to save.");
        console.error(err);
      });
    }
    $("#saveButton").click(save);

    programLoaded.then(function() { $("#loader").hide(); });
    Q.all([programLoaded, interactionsReady]).fin(function() { $("#loader").hide(); });
    editor.focus();
  });
  require(["repl-main"]);
});
function clearFlash() {
  $(".notificationArea").empty();
}
function flashError(message) {
  clearFlash();
  var err = $("<span>").addClass("error").text(message);
  $(".notificationArea").append(err);
  err.fadeOut(7000);
}
function flashMessage(message) {
  clearFlash();
  var err = $("<span>").addClass("active").text(message);
  $(".notificationArea").append(err);
  err.fadeOut(7000);
}

$(window).bind("beforeunload", function(_) {
  return "Because this page can load slowly, and you may have outstanding changes, we ask that you confirm before leaving the editor in case closing was an accident.";
});
    
</script>
</html>

